run the docker by:

```bash
docker run -d --name flexflow --gpus all --network host -it ylxdzsw/flexflow:latest /bin/bash
```

access the container by

```bash
docker exec -it flexflow bash
```

Then start `sshd` inside the docker. The port is set to 2223

```bash
/usr/sbin/sshd
```

Edit `/root/.ssh/config` to include the hosts and the ports like the following.
Note that this is neccesary as mpi do not support specifying custom ports.

```bash
Host g1
    HostName 10.28.1.16
    Port 2223

Host g2
    HostName 10.28.1.17
    Port 2223
```

If the CPU is old, it will report `Illegal Instruction (core dumped)`. Recompile with

```bash
cd /root/FlexFlow
rm -rf build
mkdir build
cd build
../config/config.linux
make -j8
```

If the GPU is old, it will report `The binary was compiled for the wrong GPU architecture.`. Do the following steps before recommpiling.

1. Edit `config/config.linux` and set `FF_CUDA_ARCH=xx` according to the error message
2. Edit `deps/legion/runtime/runtime.mk` and set `GPU_ARCH=pascal` according to your card

Then the strategy file can be generated by

```bash
mpirun --allow-run-as-root -H g1,g2,g4,g5,g7,g8,g11,g11b -mca btl_tcp_if_exclude lo,docker0 /root/FlexFlow/python/flexflow_python /root/FlexFlow/vgg.py -ll:py 1 -ll:gpu 2 -ll:fsize 10000 -ll:zsize 12192 -b 96 --export /root/FlexFlow/strategy --search-budget 100000 --enable-parameter-parallel --enable-attribute-parallel
```

Then copy the generated strategy file from rank0 to all other machines.

```bash
for rank in g1 g2 g4 g5 g7 g8 g11 g11b; do
rsync -P /root/FlexFlow/strategy "$rank":/root/FlexFlow
done
```

Finally, run it with

```
mpirun --allow-run-as-root -H g1,g2,g4,g5,g7,g8,g11,g11b -mca btl_tcp_if_exclude lo,docker0 /root/FlexFlow/python/flexflow_python /root/FlexFlow/vgg.py -ll:py 1 -ll:gpu 2 -ll:fsize 10000 -ll:zsize 12192 -b 96 --import /root/FlexFlow/strategy
```
